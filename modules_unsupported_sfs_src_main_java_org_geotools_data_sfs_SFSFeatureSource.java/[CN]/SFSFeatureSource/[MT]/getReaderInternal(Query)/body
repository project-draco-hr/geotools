{
  Filter filter=fnQuery.getFilter();
  SimplifyingFilterVisitor simplifier=new SimplifyingFilterVisitor();
  filter=(Filter)filter.accept(simplifier,null);
  Filter[] split=splitFilter(filter);
  Filter preFilter=split[0];
  Filter postFilter=split[1];
  Query preQuery=new Query(fnQuery);
  preQuery.setFilter(preFilter);
  SimpleFeatureType querySchema;
  SimpleFeatureType returnedSchema;
  if (query.getPropertyNames() == Query.ALL_NAMES) {
    returnedSchema=querySchema=getSchema();
  }
 else {
    returnedSchema=SimpleFeatureTypeBuilder.retype(getSchema(),query.getPropertyNames());
    FilterAttributeExtractor extractor=new FilterAttributeExtractor(getSchema());
    postFilter.accept(extractor,null);
    String[] extraAttributes=extractor.getAttributeNames();
    if (extraAttributes == null || extraAttributes.length == 0) {
      querySchema=returnedSchema;
    }
 else {
      List<String> allAttributes=new ArrayList<String>(Arrays.asList(query.getPropertyNames()));
      for (      String extraAttribute : extraAttributes) {
        if (!allAttributes.contains(extraAttribute)) {
          allAttributes.add(extraAttribute);
        }
      }
      String[] allAttributeArray=(String[])allAttributes.toArray(new String[allAttributes.size()]);
      querySchema=SimpleFeatureTypeBuilder.retype(getSchema(),allAttributeArray);
    }
  }
  FeatureReader<SimpleFeatureType,SimpleFeature> reader;
  reader=new SFSFeatureReader(getState(),layer,preQuery,returnedSchema);
  if (postFilter != null && postFilter != Filter.INCLUDE) {
    reader=new FilteringFeatureReader<SimpleFeatureType,SimpleFeature>(reader,postFilter);
  }
  return reader;
}
