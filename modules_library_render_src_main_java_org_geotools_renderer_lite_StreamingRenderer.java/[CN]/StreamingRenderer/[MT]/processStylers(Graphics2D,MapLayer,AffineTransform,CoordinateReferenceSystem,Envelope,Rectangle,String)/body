{
  final Style style=currLayer.getStyle();
  final FeatureSource featureSource=currLayer.getFeatureSource();
  final CoordinateReferenceSystem sourceCrs;
  final NumberRange scaleRange=NumberRange.create(scaleDenominator,scaleDenominator);
  final ArrayList<LiteFeatureTypeStyle> lfts;
  if (featureSource != null) {
    FeatureCollection features=null;
    final FeatureType schema=featureSource.getSchema();
    final GeometryDescriptor geometryAttribute=schema.getGeometryDescriptor();
    if (geometryAttribute != null && geometryAttribute.getType() != null) {
      sourceCrs=geometryAttribute.getType().getCoordinateReferenceSystem();
    }
 else {
      sourceCrs=null;
    }
    if (LOGGER.isLoggable(Level.FINE)) {
      LOGGER.fine("Processing " + style.featureTypeStyles().size() + " stylers for "+ featureSource.getSchema().getName());
    }
    lfts=createLiteFeatureTypeStyles(style.featureTypeStyles(),schema,graphics);
    if (lfts.isEmpty())     return;
    reprojectSpatialFilters(lfts,featureSource);
    applyUnitRescale(lfts);
    List<List<LiteFeatureTypeStyle>> txClassified=classifyByTransformation(lfts);
    for (    List<LiteFeatureTypeStyle> uniform : txClassified) {
      Expression transform=uniform.get(0).transformation;
      inMemoryGeneralization=true;
      FeatureCollection rawFeatures;
      Query styleQuery=getStyleQuery(featureSource,schema,uniform,mapArea,destinationCrs,sourceCrs,screenSize,geometryAttribute,at);
      Query definitionQuery=getDefinitionQuery(currLayer,featureSource,sourceCrs);
      if (transform != null) {
        GridEnvelope2D ge=new GridEnvelope2D(screenSize);
        ReferencedEnvelope re=new ReferencedEnvelope(mapArea,destinationCrs);
        GridGeometry2D gridGeometry=new GridGeometry2D(ge,re);
        rawFeatures=applyRenderingTransformation(transform,featureSource,definitionQuery,styleQuery,gridGeometry);
        if (rawFeatures == null) {
          return;
        }
      }
 else {
        Query mixed=DataUtilities.mixQueries(definitionQuery,styleQuery,null);
        checkAttributeExistence(featureSource.getSchema(),mixed);
        rawFeatures=featureSource.getFeatures(mixed);
      }
      features=prepFeatureCollection(rawFeatures,sourceCrs);
      if (!(features instanceof SimpleFeatureCollection)) {
        features.getSchema().getUserData().put("targetCrs",destinationCrs);
        features.getSchema().getUserData().put("targetVersion","wms:getmap");
      }
      if (isOptimizedFTSRenderingEnabled() && lfts.size() > 1) {
        drawOptimized(graphics,currLayer,at,destinationCrs,layerId,null,features,scaleRange,uniform);
      }
 else {
        drawPlain(graphics,currLayer,at,destinationCrs,layerId,null,features,scaleRange,uniform);
      }
    }
  }
 else {
    Collection collection=null;
    CollectionSource source=currLayer.getSource();
    collection=queryLayer(currLayer,currLayer.getSource());
    sourceCrs=null;
    lfts=createLiteFeatureTypeStyles(style.featureTypeStyles(),source.describe(),graphics);
    applyUnitRescale(lfts);
    if (lfts.isEmpty())     return;
    if (isOptimizedFTSRenderingEnabled() && lfts.size() > 1) {
      drawOptimized(graphics,currLayer,at,destinationCrs,layerId,collection,null,scaleRange,lfts);
    }
 else {
      drawPlain(graphics,currLayer,at,destinationCrs,layerId,collection,null,scaleRange,lfts);
    }
  }
}
