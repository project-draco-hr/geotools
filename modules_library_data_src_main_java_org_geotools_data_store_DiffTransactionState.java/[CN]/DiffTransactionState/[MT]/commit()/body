{
  if (diff.isEmpty()) {
    return;
  }
  FeatureWriter<SimpleFeatureType,SimpleFeature> writer;
  ContentFeatureStore store;
  ContentEntry entry=state.getEntry();
  Name name=entry.getName();
  ContentDataStore dataStore=entry.getDataStore();
  ContentFeatureSource source=(ContentFeatureSource)dataStore.getFeatureSource(name);
  if (source instanceof ContentFeatureStore) {
    store=(ContentFeatureStore)dataStore.getFeatureSource(name,transaction);
    writer=store.getWriter(Filter.INCLUDE,ContentDataStore.WRITER_COMMIT);
  }
 else {
    throw new UnsupportedOperationException("not writable");
  }
  SimpleFeature feature;
  SimpleFeature update;
  Throwable cause=null;
  try {
    while (writer.hasNext()) {
      feature=(SimpleFeature)writer.next();
      String fid=feature.getID();
      if (diff.getModified().containsKey(fid)) {
        update=(SimpleFeature)diff.getModified().get(fid);
        if (update == Diff.NULL) {
          writer.remove();
        }
 else {
          try {
            feature.setAttributes(update.getAttributes());
            writer.write();
          }
 catch (          IllegalAttributeException e) {
            throw new DataSourceException("Could update " + fid,e);
          }
        }
      }
    }
    SimpleFeature addedFeature;
    SimpleFeature nextFeature;
synchronized (diff) {
      for (      String fid : diff.getAddedOrder()) {
        addedFeature=diff.getAdded().get(fid);
        nextFeature=(SimpleFeature)writer.next();
        if (nextFeature == null) {
          throw new DataSourceException("Could not add " + fid);
        }
 else {
          try {
            nextFeature.setAttributes(addedFeature.getAttributes());
            nextFeature.getUserData().put(Hints.USE_PROVIDED_FID,true);
            if (addedFeature.getUserData().containsKey(Hints.PROVIDED_FID)) {
              String providedFid=(String)addedFeature.getUserData().get(Hints.PROVIDED_FID);
              nextFeature.getUserData().put(Hints.PROVIDED_FID,providedFid);
            }
 else {
              nextFeature.getUserData().put(Hints.PROVIDED_FID,addedFeature.getID());
            }
            writer.write();
          }
 catch (          IllegalAttributeException e) {
            throw new DataSourceException("Could update " + fid,e);
          }
        }
      }
    }
  }
 catch (  IOException e) {
    cause=e;
    throw e;
  }
catch (  RuntimeException e) {
    cause=e;
    throw e;
  }
 finally {
    try {
      writer.close();
      state.fireBatchFeatureEvent(true);
      diff.clear();
    }
 catch (    IOException e) {
      if (cause != null) {
        e.initCause(cause);
      }
      throw e;
    }
catch (    RuntimeException e) {
      if (cause != null) {
        e.initCause(cause);
      }
      throw e;
    }
  }
}
