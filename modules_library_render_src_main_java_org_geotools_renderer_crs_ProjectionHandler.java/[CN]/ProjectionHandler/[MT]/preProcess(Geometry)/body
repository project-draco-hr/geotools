{
  if (validArea == null)   return geometry;
  CoordinateReferenceSystem geometryCRS=CRS.getHorizontalCRS(sourceCRS);
  if (geometryCRS == null || CRS.equalsIgnoreMetadata(geometryCRS,renderingEnvelope.getCoordinateReferenceSystem())) {
    return geometry;
  }
  ReferencedEnvelope ge=new ReferencedEnvelope(geometry.getEnvelopeInternal(),geometryCRS);
  ReferencedEnvelope geWGS84=ge.transform(WGS84,true);
  if (validArea.contains((Envelope)geWGS84)) {
    return geometry;
  }
  ReferencedEnvelope envIntWgs84=new ReferencedEnvelope(validArea.intersection(geWGS84),WGS84);
  if (envIntWgs84.isEmpty())   return null;
  ReferencedEnvelope envInt=envIntWgs84.transform(geometryCRS,true);
  Polygon envelopeGeometry=JTS.toGeometry((Envelope)envInt);
  Geometry result;
  try {
    result=geometry.intersection(envelopeGeometry);
  }
 catch (  Exception e1) {
    try {
      result=EnhancedPrecisionOp.intersection(geometry,envelopeGeometry);
    }
 catch (    Exception e2) {
      result=geometry;
    }
  }
  if (result instanceof GeometryCollection && ((GeometryCollection)result).isEmpty())   return null;
 else   return result;
}
