{
  List features;
synchronized (CachingFeatureSource.this) {
    try {
      if (index == null || dirty || !isSubQuery(query)) {
        fillCache(query);
      }
      if (queryBounds != null) {
        features=index.query(queryBounds);
      }
 else {
        features=index.query((Envelope)index.getRoot().getBounds());
      }
    }
 catch (    Exception e) {
      throw new RuntimeException("Failed to get data",e);
    }
  }
  Iterator it=features.iterator();
  if (query.getFilter() != null && Filter.INCLUDE.equals(query.getFilter())) {
    it=new FilteringIterator<Feature>(it,query.getFilter());
  }
  if (targetSchema != sourceSchema) {
    it=new ReTypingIterator(it,sourceSchema,targetSchema);
  }
  return it;
}
