{
synchronized (locks) {
    final ReentrantLock lock=(ReentrantLock)locks.get(key);
    if (lock == null) {
      throw new IllegalMonitorStateException("Cannot unlock prior to locking");
    }
    if (lock.getHoldCount() == 0) {
      throw new IllegalMonitorStateException("Cannot unlock prior to locking");
    }
    lock.unlock();
    if (lock.getHoldCount() == 0) {
      locks.remove(key);
    }
  }
}
