{
  layer.clearCache();
  CRSEnvelope latLon=layer.getLatLonBoundingBox();
  GeneralEnvelope envelope=wms.getEnvelope(layer,crs);
  assertFalse(envelope.isEmpty() || envelope.isNull() || envelope.isInfinite());
  assertNotNull("Envelope " + CRS.toSRS(crs),envelope);
  GetMapRequest getMap=wms.createGetMapRequest();
  OperationType operationType=wms.getCapabilities().getRequest().getGetMap();
  getMap.addLayer(layer);
  String version=wms.getCapabilities().getVersion();
  String srs=CRS.toSRS(envelope.getCoordinateReferenceSystem());
  getMap.setBBox(envelope);
  String format=format(operationType,"jpeg");
  getMap.setFormat(format);
  getMap.setDimensions(500,500);
  URL url=getMap.getFinalURL();
  GetMapResponse response=wms.issueRequest(getMap);
  assertEquals("image/jpeg",response.getContentType());
  InputStream stream=response.getInputStream();
  BufferedImage image=ImageIO.read(stream);
  assertNotNull("jpeg",image);
  assertEquals(500,image.getWidth());
  assertEquals(500,image.getHeight());
  int rgb=image.getRGB(250,250);
  Color sample=new Color(rgb);
  boolean forceXY=Boolean.getBoolean(GeoTools.FORCE_LONGITUDE_FIRST_AXIS_ORDER);
  String context="srs=" + srs + " forceXY="+ forceXY+ " Version="+ version;
  if (Color.WHITE.equals(sample)) {
    System.out.println("FAIL: " + context + ": GetMap BBOX="+ envelope);
    System.out.println("--> " + url);
    fail(context + ": GetMap BBOX=" + envelope);
  }
 else {
  }
}
