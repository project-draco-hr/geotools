{
  curPaintArea=getVisibleRect();
  if (event.type == SWT.MouseDown) {
    startX=event.x;
    startY=event.y;
    mouseDown=true;
  }
 else   if (event.type == SWT.MouseUp) {
    endX=event.x;
    endY=event.y;
    boolean mouseWasMoved=startX != endX || startY != endY;
    if (toolCanMove && mouseWasMoved) {
      afterImageMove();
    }
    mouseDown=false;
    isDragging=false;
  }
 else   if (event.type == SWT.Paint) {
    if (acceptRepaintRequests) {
      gc=event.gc;
      if (toolCanMove && isDragging) {
        if (gc != null && !gc.isDisposed() && swtImage != null) {
          Image tmpImage=new Image(getDisplay(),curPaintArea.width,curPaintArea.height);
          GC tmpGc=new GC(tmpImage);
          tmpGc.setBackground(white);
          tmpGc.fillRectangle(0,0,curPaintArea.width,curPaintArea.height);
          tmpGc.drawImage(swtImage,imageOrigin.x,imageOrigin.y);
          gc.drawImage(tmpImage,0,0);
          tmpImage.dispose();
        }
        return;
      }
      if (toolCanDraw && toolManager.getCursorTool().isDrawing() && isDragging) {
        if (swtImage != null) {
          drawFinalImage(swtImage);
        }
        gc.setXORMode(true);
        org.eclipse.swt.graphics.Color fC=gc.getForeground();
        gc.setLineStyle(cursorToolLineStyle);
        gc.setLineWidth(cursorToolLineWidth);
        gc.setForeground(cursorToolColor);
        gc.drawRectangle(startX,startY,endX - startX,endY - startY);
        gc.setForeground(fC);
        gc.setXORMode(false);
        return;
      }
      if (!toolCanDraw && !toolCanMove && isDragging) {
        return;
      }
      if (curPaintArea == null || content == null || renderer == null) {
        return;
      }
      if (content.layers().size() == 0) {
        gc.setForeground(yellow);
        gc.fillRectangle(0,0,curPaintArea.width + 1,curPaintArea.height + 1);
        if (overlayImage == null)         return;
      }
      final ReferencedEnvelope mapAOI=content.getViewport().getBounds();
      if (mapAOI == null) {
        return;
      }
      if (redrawBaseImage) {
        MapPaneEvent ev=new MapPaneEvent(this,MapPaneEvent.Type.RENDERING_STARTED);
        publishEvent(ev);
        baseImage=new BufferedImage(curPaintArea.width + 1,curPaintArea.height + 1,BufferedImage.TYPE_INT_ARGB);
        Graphics2D g2d=baseImage.createGraphics();
        g2d.fillRect(0,0,curPaintArea.width + 1,curPaintArea.height + 1);
        g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_ON);
        java.awt.Rectangle awtRectangle=Utils.toAwtRectangle(curPaintArea);
        renderer.paint(g2d,awtRectangle,mapAOI,getWorldToScreenTransform());
        if (swtImage != null && !swtImage.isDisposed()) {
          swtImage.dispose();
          swtImage=null;
        }
        swtImage=new Image(getDisplay(),awtToSwt(baseImage,curPaintArea.width + 1,curPaintArea.height + 1));
      }
      if (swtImage != null) {
        drawFinalImage(swtImage);
      }
      MapPaneEvent ev=new MapPaneEvent(this,MapPaneEvent.Type.RENDERING_STOPPED);
      publishEvent(ev);
      clearLabelCache=true;
      onRenderingCompleted();
      redrawBaseImage=false;
    }
  }
}
