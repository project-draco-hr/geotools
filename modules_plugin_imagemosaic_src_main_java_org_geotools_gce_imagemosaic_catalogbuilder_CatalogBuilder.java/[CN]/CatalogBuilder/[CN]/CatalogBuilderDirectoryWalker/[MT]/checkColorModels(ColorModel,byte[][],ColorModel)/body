{
  if (defaultCM instanceof ComponentColorModel && actualCM instanceof ComponentColorModel) {
    final ComponentColorModel defCCM=(ComponentColorModel)defaultCM, actualCCM=(ComponentColorModel)actualCM;
    final ColorSpace defCS=defCCM.getColorSpace();
    final ColorSpace actualCS=actualCCM.getColorSpace();
    final boolean isBogusDef=defCS instanceof BogusColorSpace;
    final boolean isBogusActual=actualCS instanceof BogusColorSpace;
    final boolean colorSpaceIsOk;
    if (isBogusDef && isBogusActual) {
      final BogusColorSpace def=(BogusColorSpace)defCS;
      final BogusColorSpace act=(BogusColorSpace)actualCS;
      colorSpaceIsOk=def.getNumComponents() == act.getNumComponents() && def.isCS_sRGB() == act.isCS_sRGB() && def.getType() == act.getType();
    }
 else     colorSpaceIsOk=defCS.equals(actualCS);
    return !(defCCM.getNumColorComponents() == actualCCM.getNumColorComponents() && defCCM.hasAlpha() == actualCCM.hasAlpha() && colorSpaceIsOk && defCCM.getTransparency() == actualCCM.getTransparency() && defCCM.getTransferType() == actualCCM.getTransferType());
  }
  if (defaultCM instanceof IndexColorModel && actualCM instanceof IndexColorModel) {
    final IndexColorModel defICM=(IndexColorModel)defaultCM, actualICM=(IndexColorModel)actualCM;
    if (defICM.getNumColorComponents() != actualICM.getNumColorComponents() || defICM.hasAlpha() != actualICM.hasAlpha() || !defICM.getColorSpace().equals(actualICM.getColorSpace()) || defICM.getTransferType() != actualICM.getTransferType())     return true;
    if (defICM.getMapSize() != actualICM.getMapSize() || defICM.getTransparency() != actualICM.getTransparency() || defICM.getTransferType() != actualICM.getTransferType() || defICM.getTransparentPixel() != actualICM.getTransparentPixel()) {
      mustConvertToRGB=true;
      return false;
    }
    int numBands=actualICM.getNumColorComponents();
    byte[][] actualPalette=new byte[3][actualICM.getMapSize()];
    actualICM.getReds(actualPalette[0]);
    actualICM.getGreens(actualPalette[0]);
    actualICM.getBlues(actualPalette[0]);
    if (numBands == 4)     actualICM.getAlphas(defaultPalette[0]);
    for (int i=0; i < defICM.getMapSize(); i++)     for (int j=0; j < numBands; j++)     if (actualPalette[j][i] != defaultPalette[j][i]) {
      mustConvertToRGB=true;
      break;
    }
    return false;
  }
  return true;
}
