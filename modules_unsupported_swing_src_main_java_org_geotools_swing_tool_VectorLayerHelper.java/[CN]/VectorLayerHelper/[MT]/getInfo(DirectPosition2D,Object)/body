{
  FeatureCollection<? extends FeatureType,? extends Feature> collection=null;
  Layer layer=layerRef.get();
  if (layer != null) {
    Filter filter=null;
    if (isPolygonGeometry) {
      Geometry posGeom=createSearchPos(pos);
      filter=filterFactory.intersects(filterFactory.property(attrName),filterFactory.literal(posGeom));
    }
 else {
      double radius=((Number)params[0]).doubleValue();
      ReferencedEnvelope env=createSearchEnv(pos,radius);
      filter=filterFactory.bbox(filterFactory.property(attrName),env);
    }
    DefaultQuery query=new DefaultQuery(null,filter);
    query.setCoordinateSystemReproject(getMapContent().getCoordinateReferenceSystem());
    collection=layer.getFeatureSource().getFeatures(query);
  }
  return collection;
}
