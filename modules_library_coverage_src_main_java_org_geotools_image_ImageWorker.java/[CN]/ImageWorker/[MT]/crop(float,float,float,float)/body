{
  if (image.getMinX() == x && image.getMinY() == y && image.getWidth() == width && image.getHeight() == height) {
    return this;
  }
  RenderedImage source=image;
  if (image instanceof RenderedOp) {
    RenderedOp op=(RenderedOp)image;
    if ("Crop".equals(op.getOperationName()) || "GTCrop".equals(op.getOperationName())) {
      ParameterBlock paramBlock=op.getParameterBlock();
      source=paramBlock.getRenderedSource(0);
      float sx=paramBlock.getFloatParameter(0);
      float sy=paramBlock.getFloatParameter(1);
      float sWidth=paramBlock.getFloatParameter(2);
      float sHeight=paramBlock.getFloatParameter(3);
      Rectangle2D.Float sourceBounds=new Rectangle2D.Float(sx,sy,sWidth,sHeight);
      Rectangle2D.Float bounds=new Rectangle.Float(x,y,width,height);
      Rectangle2D intersection=bounds.createIntersection(sourceBounds);
      x=(float)intersection.getMinX();
      y=(float)intersection.getMinY();
      width=(float)intersection.getWidth();
      height=(float)intersection.getHeight();
    }
  }
  ParameterBlock pb=new ParameterBlock();
  pb.setSource(source,0);
  pb.set(x,0);
  pb.set(y,1);
  pb.set(width,2);
  pb.set(height,3);
  pb.set(roi,4);
  pb.set(nodata,5);
  if (isNoDataNeeded()) {
    if (background != null && background.length > 0) {
      pb.set(background,6);
      setNoData(RangeFactory.create(background[0],background[0]));
    }
  }
  image=JAI.create("Crop",pb,commonHints);
  return this;
}
