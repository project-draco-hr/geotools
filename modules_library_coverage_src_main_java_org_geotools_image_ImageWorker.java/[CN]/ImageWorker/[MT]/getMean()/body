{
  Object mean=getComputedProperty(MEAN);
  if (!(mean instanceof double[])) {
    final Integer ONE=1;
    ParameterBlock pb=new ParameterBlock();
    pb.setSource(image,0);
    if (JAIExt.isJAIExtOperation("Stats")) {
      StatsType[] stats=new StatsType[]{StatsType.MEAN};
      int numBands=getNumBands();
      int[] bands=new int[numBands];
      for (int i=0; i < numBands; i++) {
        bands[i]=i;
      }
      pb.set(ONE,0);
      pb.set(ONE,1);
      pb.set(roi,2);
      pb.set(nodata,3);
      pb.set(bands,5);
      pb.set(stats,6);
      image=JAI.create("Stats",pb,getRenderingHints());
      Statistics[][] results=(Statistics[][])getComputedProperty(Statistics.STATS_PROPERTY);
      double[] meanBands=new double[numBands];
      for (int i=0; i < numBands; i++) {
        meanBands[i]=(double)results[i][0].getResult();
      }
      if (image instanceof PlanarImage) {
        ((PlanarImage)image).setProperty(MEAN,meanBands);
      }
 else {
        PlanarImage p=getPlanarImage();
        p.setProperty(MEAN,meanBands);
        image=p;
      }
    }
 else {
      pb.set(roi,0);
      pb.set(ONE,1);
      pb.set(ONE,2);
      image=JAI.create("Mean",pb,getRenderingHints());
    }
    mean=getComputedProperty(MEAN);
  }
  return (double[])mean;
}
