{
  JPopupMenu menu=new JPopupMenu();
  for (  Entry<Integer,ItemElement> entry : itemStates.entrySet()) {
    final ItemElement el=entry.getValue();
    if (el.configurable) {
      JMenuItem menuItem=new JCheckBoxMenuItem(el.item.getName(),el.showing);
      menuItem.addActionListener(new ActionListener(){
        @Override public void actionPerformed(        ActionEvent e){
          el.showing=!el.showing;
          Rectangle r=el.item.getBounds();
          if (el.showing) {
            add(el.item,el.componentIndex);
          }
 else {
            remove(el.item);
          }
          revalidate();
          repaint(r);
        }
      }
);
      menu.add(menuItem);
    }
  }
  return menu;
}
