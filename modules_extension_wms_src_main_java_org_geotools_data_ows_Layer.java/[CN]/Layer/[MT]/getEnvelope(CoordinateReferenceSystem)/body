{
  if (crs == null) {
    return null;
  }
  GeneralEnvelope found=(GeneralEnvelope)envelopeCache.get(crs);
  if (found != null) {
    return found;
  }
  Collection<Object> identifiers=new ArrayList<Object>();
  identifiers.addAll(crs.getIdentifiers());
  if (crs == DefaultGeographicCRS.WGS84 || crs == DefaultGeographicCRS.WGS84_3D) {
    identifiers.add("CRS:84");
  }
  for (  Object identifier : identifiers) {
    String srsName=identifier.toString();
    CRSEnvelope tempBBox=null;
    Layer layer=this;
    Map<String,CRSEnvelope> boxes=layer.getBoundingBoxes();
    tempBBox=(CRSEnvelope)boxes.get(srsName);
    if (tempBBox == null && ("EPSG:4326".equals(srsName.toUpperCase()))) {
      CRSEnvelope latLonBBox=null;
      layer=this;
      while (latLonBBox == null && layer != null) {
        latLonBBox=layer.getLatLonBoundingBox();
        if (latLonBBox != null) {
          try {
            new GeneralEnvelope(new double[]{latLonBBox.getMinX(),latLonBBox.getMinY()},new double[]{latLonBBox.getMaxX(),latLonBBox.getMaxY()});
            break;
          }
 catch (          IllegalArgumentException e) {
            latLonBBox=null;
          }
        }
        layer=layer.getParent();
      }
      if (latLonBBox != null) {
        tempBBox=new CRSEnvelope("CRS:84",latLonBBox.getMinX(),latLonBBox.getMinY(),latLonBBox.getMaxX(),latLonBBox.getMaxY());
      }
 else {
        tempBBox=new CRSEnvelope("CRS:84",-180,-90,180,90);
      }
    }
    if (tempBBox == null) {
      String epsg=null;
      if (getLatLonBoundingBox() != null) {
        CRSEnvelope latLonBBox=getLatLonBoundingBox();
        tempBBox=new CRSEnvelope("EPSG:4326",latLonBBox.getMinX(),latLonBBox.getMinY(),latLonBBox.getMaxX(),latLonBBox.getMaxY());
        epsg="EPSG:4326";
      }
      if (tempBBox == null && getBoundingBoxes() != null && getBoundingBoxes().size() > 0) {
        tempBBox=(CRSEnvelope)getBoundingBoxes().values().iterator().next();
        epsg=tempBBox.getEPSGCode();
      }
      if (tempBBox == null) {
        continue;
      }
      GeneralEnvelope env=new GeneralEnvelope(new double[]{tempBBox.getMinX(),tempBBox.getMinY()},new double[]{tempBBox.getMaxX(),tempBBox.getMaxY()});
      CoordinateReferenceSystem fromCRS=null;
      try {
        fromCRS=CRS.decode(epsg);
        ReferencedEnvelope oldEnv=new ReferencedEnvelope(env.getMinimum(0),env.getMaximum(0),env.getMinimum(1),env.getMaximum(1),fromCRS);
        ReferencedEnvelope newEnv=oldEnv.transform(crs,true);
        env=new GeneralEnvelope(new double[]{newEnv.getMinimum(0),newEnv.getMinimum(1)},new double[]{newEnv.getMaximum(0),newEnv.getMaximum(1)});
        env.setCoordinateReferenceSystem(crs);
        envelopeCache.put(crs,env);
        return env;
      }
 catch (      NoSuchAuthorityCodeException e) {
      }
catch (      FactoryException e) {
      }
catch (      MismatchedDimensionException e) {
      }
catch (      TransformException e) {
      }
    }
    if (tempBBox != null) {
      GeneralEnvelope env;
      try {
        Envelope fixed=CRS.transform(tempBBox,crs);
        env=new GeneralEnvelope(fixed);
      }
 catch (      TransformException e) {
        env=new GeneralEnvelope(new double[]{tempBBox.getMinX(),tempBBox.getMinY()},new double[]{tempBBox.getMaxX(),tempBBox.getMaxY()});
        env.setCoordinateReferenceSystem(crs);
      }
      return env;
    }
  }
  return null;
}
