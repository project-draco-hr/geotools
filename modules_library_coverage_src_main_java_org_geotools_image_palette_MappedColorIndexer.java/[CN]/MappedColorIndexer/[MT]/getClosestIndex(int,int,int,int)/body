{
  int sr=r;
  int sg=g;
  int sb=b;
  int sa=a;
  if (shift > 0) {
    sr=r >> shift;
    sg=g >> shift;
    sb=b >> shift;
    sa=a >> shift;
  }
  if (a <= PackedHistogram.ALPHA_THRESHOLD) {
    sr=255;
    sg=255;
    sb=255;
    sa=0;
  }
synchronized (colorMap) {
    int idx=colorMap.get(sr,sg,sb,sa);
    if (idx < 0) {
      idx=delegate.getClosestIndex(r,g,b,a);
      colorMap.put(sr,sg,sb,sa,idx);
    }
    return idx;
  }
}
