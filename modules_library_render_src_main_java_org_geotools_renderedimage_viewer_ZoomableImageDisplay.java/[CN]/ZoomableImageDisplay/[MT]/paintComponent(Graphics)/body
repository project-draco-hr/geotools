{
  Graphics2D g2d=(Graphics2D)g;
  Rectangle clipBounds=g2d.getClipBounds();
  g2d.setColor(getBackground());
  g2d.fillRect(clipBounds.x,clipBounds.y,clipBounds.width,clipBounds.height);
  if (image == null)   return;
  try {
    g2d.drawRenderedImage(image,AffineTransform.getScaleInstance(scale,scale));
  }
 catch (  Throwable e) {
    e.printStackTrace();
  }
  if (tileGridVisible) {
    g2d.setColor(Color.WHITE);
    g2d.setXORMode(Color.BLACK);
    final int x=(int)Math.floor(image.getTileGridXOffset() * scale);
    final int y=(int)Math.floor(image.getTileGridYOffset() * scale);
    final int th=(int)Math.round(image.getTileHeight() * scale);
    final int tw=(int)Math.round(image.getTileWidth() * scale);
    final int xCount=image.getNumXTiles();
    final int yCount=image.getNumYTiles();
    final int minty=image.getMinTileY();
    final int mintx=image.getMinTileX();
    for (int i=mintx; i < xCount + mintx + 1; i++) {
      g2d.drawLine(x + tw * i,y + th * minty,x + tw * i,y + th * (yCount + minty));
    }
    for (int j=minty; j < yCount + minty + 1; j++) {
      g2d.drawLine(x + mintx * tw,y + th * j,x + tw * (xCount + mintx),y + th * j);
    }
  }
}
