{
  final IndexColorModel colors;
  final BufferedImage image;
  final WritableRaster raster;
  colors=(IndexColorModel)getColorModel();
  raster=colors.createCompatibleWritableRaster(size.width,size.height);
  image=new BufferedImage(colors,raster,false,null);
  int xmin=raster.getMinX();
  int ymin=raster.getMinY();
  int width=raster.getWidth();
  int height=raster.getHeight();
  final boolean horizontal=size.width >= size.height;
  if (!horizontal) {
    int tmp;
    tmp=xmin;
    xmin=ymin;
    ymin=tmp;
    tmp=width;
    width=height;
    height=tmp;
  }
  final int xmax=xmin + width;
  final int ymax=ymin + height;
  final double scale=getScale() / width;
  final double offset=getOffset();
  for (int x=xmin; x < xmax; x++) {
    final double value=offset + scale * (x - xmin);
    for (int y=ymin; y < ymax; y++) {
      if (horizontal) {
        raster.setSample(x,y,0,value);
      }
 else {
        raster.setSample(y,x,0,value);
      }
    }
  }
  return image;
}
