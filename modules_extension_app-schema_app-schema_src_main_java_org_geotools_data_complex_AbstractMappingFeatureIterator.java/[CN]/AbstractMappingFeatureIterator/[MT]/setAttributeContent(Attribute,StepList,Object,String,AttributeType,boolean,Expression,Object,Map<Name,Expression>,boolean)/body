{
  Attribute instance=null;
  Map<Name,Expression> properties=new HashMap<Name,Expression>(clientProperties);
  if (ignoreXlinkHref) {
    properties.remove(XLINK_HREF_NAME);
  }
  if (properties.containsKey(XLINK_HREF_NAME) && resolveDepth > 0) {
    String refid=referenceToIdentifier(getValue(properties.get(XLINK_HREF_NAME),source).toString());
    if (refid != null) {
      final Hints hints=new Hints();
      if (resolveDepth > 1) {
        hints.put(Hints.RESOLVE,ResolveValueType.ALL);
        hints.put(Hints.RESOLVE_TIMEOUT,Integer.MAX_VALUE);
        hints.put(Hints.ASSOCIATION_TRAVERSAL_DEPTH,resolveDepth - 1);
      }
 else {
        hints.put(Hints.RESOLVE,ResolveValueType.NONE);
      }
      FeatureFinder finder=new FeatureFinder(refid,hints);
      Feature foundFeature=null;
      if (resolveTimeOut == Integer.MAX_VALUE) {
        finder.run();
        foundFeature=finder.getFeature();
      }
 else {
        Thread thread=new Thread(finder);
        long startTime=System.currentTimeMillis();
        thread.start();
        try {
          while (thread.isAlive() && (System.currentTimeMillis() - startTime) / 1000 < resolveTimeOut) {
            Thread.sleep(RESOLVE_TIMEOUT_POLL_INTERVAL);
          }
          thread.interrupt();
          thread.join();
          foundFeature=finder.getFeature();
        }
 catch (        InterruptedException e) {
          thread.interrupt();
          throw new RuntimeException("Interrupted while resolving resource " + refid);
        }
      }
      if (foundFeature != null) {
        instance=xpathAttributeBuilder.set(target,xpath,Collections.singletonList(foundFeature),id,targetNodeType,false,sourceExpression);
        properties.remove(XLINK_HREF_NAME);
      }
    }
  }
  if (instance == null) {
    instance=xpathAttributeBuilder.set(target,xpath,value,id,targetNodeType,false,sourceExpression);
  }
  setClientProperties(instance,source,properties);
  return instance;
}
