{
  this.store=store;
  this.attf=new AppSchemaFeatureFactoryImpl();
  this.mapping=mapping;
  namespaces=mapping.getNamespaces();
  namespaceAwareFilterFactory=new FilterFactoryImplNamespaceAware(namespaces);
  Object includeProps=query.getHints().get(Query.INCLUDE_MANDATORY_PROPS);
  includeMandatory=includeProps instanceof Boolean && ((Boolean)includeProps).booleanValue();
  if (query != null && query.getProperties() != null) {
    setPropertyNames(query.getProperties());
  }
 else {
    setPropertyNames(null);
  }
  this.maxFeatures=query.getMaxFeatures();
  if (unrolledQuery == null) {
    unrolledQuery=getUnrolledQuery(query);
  }
  xpathAttributeBuilder=new XPath();
  xpathAttributeBuilder.setFeatureFactory(attf);
  initialiseSourceFeatures(mapping,unrolledQuery,query.getCoordinateSystemReproject());
  xpathAttributeBuilder.setFilterFactory(namespaceAwareFilterFactory);
}
