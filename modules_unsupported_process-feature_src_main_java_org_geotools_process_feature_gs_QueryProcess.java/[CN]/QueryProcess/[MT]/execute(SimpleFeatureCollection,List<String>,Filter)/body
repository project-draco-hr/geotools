{
  if (filter != null && !filter.equals(Filter.INCLUDE)) {
    features=new FilteringSimpleFeatureCollection(features,filter);
  }
  if (attributes != null && attributes.size() > 0) {
    final String[] names=(String[])attributes.toArray(new String[attributes.size()]);
    SimpleFeatureType ft=SimpleFeatureTypeBuilder.retype(features.getSchema(),names);
    if (!(ft.equals(features.getSchema()))) {
      features=new ReTypingFeatureCollection(features,ft);
    }
  }
  return features;
}
