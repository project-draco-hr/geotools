{
  final File testMosaic=TestData.file(this,"/empty_mosaic/empty_mosaic.shp");
  assertTrue(testMosaic.exists());
  ImageMosaicReader reader=(ImageMosaicReader)new ImageMosaicFormat().getReader(testMosaic);
  reader.granuleCatalog.removeGranules(new Query("empty_mosaic",Filter.INCLUDE));
  reader.dispose();
  reader=(ImageMosaicReader)new ImageMosaicFormat().getReader(testMosaic);
  final RasterManager manager=reader.getRasterManager(reader.getGridCoverageNames()[0]);
  assertTrue(manager.spatialDomainManager.coverageBBox.isEmpty());
  ParameterValue<GridGeometry2D> gg=AbstractGridFormat.READ_GRIDGEOMETRY2D.createValue();
  GeneralEnvelope envelope=reader.getOriginalEnvelope();
  Rectangle rasterArea=((GridEnvelope2D)reader.getOriginalGridRange());
  GridEnvelope2D range=new GridEnvelope2D(rasterArea);
  gg.setValue(new GridGeometry2D(range,envelope));
  GridCoverage2D coverage=reader.read(new GeneralParameterValue[]{gg});
  assertNull(coverage);
  coverage=reader.read(null);
  assertNull(coverage);
  final ParameterValue<Boolean> useJai=AbstractGridFormat.USE_JAI_IMAGEREAD.createValue();
  useJai.setValue(false);
  final ParameterValue<String> tileSize=AbstractGridFormat.SUGGESTED_TILE_SIZE.createValue();
  tileSize.setValue("128,128");
  final ParameterValue<double[]> bkg=ImageMosaicFormat.BACKGROUND_VALUES.createValue();
  bkg.setValue(new double[]{-9999.0});
  gg=AbstractGridFormat.READ_GRIDGEOMETRY2D.createValue();
  Envelope2D env=new Envelope2D(reader.getCoordinateReferenceSystem(),0,0,1000,1000);
  GridGeometry2D gg2D=new GridGeometry2D(new GridEnvelope2D(0,0,100,100),(Envelope)env);
  gg.setValue(gg2D);
  coverage=reader.read(new GeneralParameterValue[]{bkg,gg,useJai,tileSize});
  assertNull(coverage);
  SimpleFeatureType granuleType=reader.granuleCatalog.getType(reader.granuleCatalog.getTypeNames()[0]);
  GeometryFactory gf=new GeometryFactory();
  SimpleFeatureBuilder sFB=new SimpleFeatureBuilder(granuleType);
  SimpleFeature f=sFB.buildFeature(null);
  f.setAttribute("location","addedGranule.tif");
  LinearRing shell=gf.createLinearRing(new Coordinate[]{new Coordinate(0,0),new Coordinate(0,5903),new Coordinate(5662,5903),new Coordinate(5662,0),new Coordinate(0,0)});
  f.setDefaultGeometry(gf.createPolygon(shell));
  List<SimpleFeature> granules=new LinkedList<SimpleFeature>();
  granules.add(f);
  reader.granuleCatalog.addGranules("empty_mosaic",granules,null);
  manager.initialize(false);
  assertFalse(manager.spatialDomainManager.coverageBBox.isEmpty());
  coverage=reader.read(null);
  assertNotNull(coverage);
  assertNotNull(coverage.getRenderedImage());
  coverage.dispose(true);
  coverage=reader.read(new GeneralParameterValue[]{bkg,gg,useJai,tileSize});
  assertNotNull(coverage);
  assertNotNull(coverage.getRenderedImage());
  coverage.dispose(true);
  reader.granuleCatalog.removeGranules(new Query("empty_mosaic",Filter.INCLUDE));
  manager.initialize(false);
  assertTrue(manager.spatialDomainManager.coverageBBox.isEmpty());
  coverage=reader.read(null);
  assertNull(coverage);
  coverage=reader.read(new GeneralParameterValue[]{bkg,gg,useJai,tileSize});
  assertNull(coverage);
  reader.dispose();
}
