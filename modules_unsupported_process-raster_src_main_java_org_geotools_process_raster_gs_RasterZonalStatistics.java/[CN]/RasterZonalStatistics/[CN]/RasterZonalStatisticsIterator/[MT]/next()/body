{
  if (features.size() == 0) {
    SimpleFeature zone=zones.next();
    try {
      Geometry zoneGeom=(Geometry)zone.getDefaultGeometry();
      CoordinateReferenceSystem dataCrs=dataCoverage.getCoordinateReferenceSystem();
      CoordinateReferenceSystem zonesCrs=builder.getFeatureType().getGeometryDescriptor().getCoordinateReferenceSystem();
      if (!CRS.equalsIgnoreMetadata(zonesCrs,dataCrs)) {
        zoneGeom=JTS.transform(zoneGeom,CRS.findMathTransform(zonesCrs,dataCrs,true));
      }
      ZonalStats stats=processStatistics(zoneGeom);
      if (stats != null) {
        if (classificationRaster != null) {
          for (          Integer classZoneId : stats.getZones()) {
            builder.addAll(zone.getAttributes());
            builder.add(classZoneId);
            addStatsToFeature(stats.zone(classZoneId));
            features.add(builder.buildFeature(zone.getID()));
          }
        }
 else {
          builder.addAll(zone.getAttributes());
          addStatsToFeature(stats);
          features.add(builder.buildFeature(zone.getID()));
        }
      }
 else {
        builder.addAll(zone.getAttributes());
        features.add(builder.buildFeature(zone.getID()));
      }
    }
 catch (    Exception e) {
      throw new ProcessException("Failed to compute statistics on feature " + zone,e);
    }
  }
  SimpleFeature f=features.remove(0);
  return f;
}
