{
synchronized (transaction) {
    VersionedJdbcTransactionState state;
    state=(VersionedJdbcTransactionState)transaction.getState(this);
    if (state == null) {
      try {
        Connection conn=createConnection();
        conn.setAutoCommit(requireAutoCommit());
        if (getTransactionIsolation() != Connection.TRANSACTION_NONE) {
          conn.setTransactionIsolation(getTransactionIsolation());
        }
        state=new VersionedJdbcTransactionState(conn,this);
        transaction.putState(this,state);
      }
 catch (      SQLException eep) {
        throw new DataSourceException("Connection failed:" + eep,eep);
      }
    }
    return state;
  }
}
