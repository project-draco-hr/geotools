{
  if (isVersioned()) {
    checkTransaction();
  }
  final FeatureStore<T,F> unversioned=getUnversionedStore();
  List<FeatureId> unversionedIds=unversioned.addFeatures(collection);
  if (isVersioned()) {
    try {
      final Name typeName=getSchema().getName();
      VersioningTransactionState versioningState=getVersioningState();
      FilterFactory2 ff=CommonFactoryFinder.getFilterFactory2(null);
      Id id=ff.id(new HashSet<Identifier>(unversionedIds));
      FeatureCollection<T,F> inserted=unversioned.getFeatures(id);
      List<FeatureId> versionedIds;
      versionedIds=versioningState.stageInsert(typeName,inserted,true);
      return versionedIds;
    }
 catch (    Exception e) {
      Throwables.propagate(e);
    }
  }
  return unversionedIds;
}
