{
  if (progress == null) {
    progress=new NullProgressListener();
  }
  if (handleVisitor(query,visitor)) {
    return;
  }
  FeatureReader<SimpleFeatureType,SimpleFeature> reader=getReader(query);
  try {
    float size=progress instanceof NullProgressListener ? 0.0f : (float)getCount(query);
    float position=0;
    progress.started();
    while (reader.hasNext()) {
      if (size > 0)       progress.progress(position++ / size);
      try {
        SimpleFeature feature=reader.next();
        visitor.visit(feature);
      }
 catch (      Exception erp) {
        progress.exceptionOccurred(erp);
      }
    }
  }
  finally {
    progress.complete();
    reader.close();
  }
}
