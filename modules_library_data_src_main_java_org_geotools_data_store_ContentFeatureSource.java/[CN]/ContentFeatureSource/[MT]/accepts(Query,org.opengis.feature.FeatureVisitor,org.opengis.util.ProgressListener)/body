{
  if (progress == null) {
    progress=new NullProgressListener();
  }
  if (handleVisitor(query,visitor)) {
    return;
  }
  FeatureReader<SimpleFeatureType,SimpleFeature> reader=getReader(query);
  try {
    float size=progress instanceof NullProgressListener ? 0.0f : (float)getCount(query);
    float position=0;
    progress.started();
    while (reader.hasNext()) {
      SimpleFeature feature=null;
      if (size > 0)       progress.progress(position++ / size);
      try {
        feature=reader.next();
        visitor.visit(feature);
      }
 catch (      IOException erp) {
        progress.exceptionOccurred(erp);
        throw erp;
      }
catch (      Exception unexpected) {
        progress.exceptionOccurred(unexpected);
        String fid=feature == null ? "feature" : feature.getIdentifier().toString();
        throw new IOException("Problem visiting " + query.getTypeName() + " visiting "+ fid+ ":"+ unexpected,unexpected);
      }
    }
  }
  finally {
    progress.complete();
    reader.close();
  }
}
