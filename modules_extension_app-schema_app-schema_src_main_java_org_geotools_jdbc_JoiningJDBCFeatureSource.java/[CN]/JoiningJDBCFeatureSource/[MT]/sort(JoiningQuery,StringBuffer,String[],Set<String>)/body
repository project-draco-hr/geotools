{
  boolean orderby=false;
  Set<String> orderByFields=new LinkedHashSet<String>();
  for (int j=query.getQueryJoins() == null ? -1 : query.getQueryJoins().size() - 1; j >= -1; j--) {
    JoiningQuery.QueryJoin join=j < 0 ? null : query.getQueryJoins().get(j);
    SortBy[] sort=j < 0 ? query.getSortBy() : join.getSortBy();
    if ((sort != null) && (sort.length > 0)) {
      if (!orderby) {
        orderby=true;
        sql.append(" ORDER BY ");
      }
      if (j < 0) {
        sort(query.getTypeName(),sort,orderByFields,false,sql);
        if (query.getQueryJoins() != null && query.getQueryJoins().size() > 0) {
          addMultiValuedSort(query.getTypeName(),orderByFields,query.getQueryJoins().get(0),sql);
        }
        if (!pkColumnNames.isEmpty()) {
          for (          String pk : pkColumnNames) {
            StringBuffer pkSql=new StringBuffer();
            encodeColumnName(pk,query.getTypeName(),pkSql,null);
            if (!pkSql.toString().isEmpty() && orderByFields.add(pkSql.toString())) {
              if (orderByFields.size() > 1) {
                sql.append(", ");
              }
              sql.append(pkSql);
            }
          }
        }
      }
 else {
        if (aliases != null && aliases[j] != null) {
          sort(aliases[j],sort,orderByFields,true,sql);
        }
 else {
          sort(join.getJoiningTypeName(),sort,orderByFields,false,sql);
        }
        if (query.getQueryJoins().size() > j + 1) {
          addMultiValuedSort(join.getJoiningTypeName(),orderByFields,query.getQueryJoins().get(j + 1),sql);
        }
      }
    }
  }
}
