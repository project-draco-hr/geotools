{
  if (perParameterSetDataStoreCache.containsKey(params)) {
    return perParameterSetDataStoreCache.get(params);
  }
  final URL getQueryRequest=(URL)GET_CONNECTION_URL.lookUp(params);
  final int timeoutMillis=(Integer)TIMEOUT.lookUp(params);
  final boolean tryGZIP=(Boolean)TRY_GZIP.lookUp(params);
  final String templateName=(String)TEMPLATE_NAME.lookUp(params);
  final URL templateDirectory=(URL)TEMPLATE_DIRECTORY.lookUp(params);
  final URL capabilitiesDirectory=(URL)CAPABILITIES_FILE_LOCATION.lookUp(params);
  final HTTPProtocol http=new SimpleHttpProtocol();
  http.setTryGzip(tryGZIP);
  http.setTimeoutMillis(timeoutMillis);
  InputStream capsIn=new BufferedInputStream(new FileInputStream(DataUtilities.urlToFile(capabilitiesDirectory)));
  WSStrategy strategy=determineCorrectStrategy(templateDirectory,templateName);
  WS_Protocol ws=new WS_Protocol(capsIn,strategy,getQueryRequest,http);
  final XmlDataStore dataStore=new WS_DataStore(ws);
  perParameterSetDataStoreCache.put(new HashMap(params),dataStore);
  return dataStore;
}
