{
  SimpleFeatureType resultSchema=getResultType(q);
  List<AttributeDescriptor> attributes=resultSchema.getAttributeDescriptors();
  GeometryFactory geometryFactory=getGeometryFactory(q);
  ShapefileReader shapeReader=openShapeReader(geometryFactory);
  ShapefileFeatureReader result;
  if (attributes.size() < 1 || (attributes.size() == 1 && resultSchema.getGeometryDescriptor() != null)) {
    LOGGER.fine("The DBF file won't be opened since no attributes will be read from it");
    result=new ShapefileFeatureReader(resultSchema,shapeReader,null);
  }
 else {
    result=new ShapefileFeatureReader(resultSchema,shapeReader,openDbfReader());
  }
  if (q != null) {
    Envelope bbox=new ReferencedEnvelope();
    bbox=(Envelope)q.getFilter().accept(ExtractBoundsFilterVisitor.BOUNDS_VISITOR,bbox);
    if (bbox != null && !bbox.isNull()) {
      result.setTargetBBox(bbox);
    }
    Hints hints=q.getHints();
    if (hints != null) {
      Number simplificationDistance=(Number)hints.get(Hints.GEOMETRY_DISTANCE);
      if (simplificationDistance != null) {
        result.setSimplificationDistance(simplificationDistance.doubleValue());
      }
      result.setScreenMap((ScreenMap)hints.get(Hints.SCREENMAP));
      if (Boolean.TRUE.equals(hints.get(Hints.FEATURE_2D))) {
        shapeReader.setFlatGeometry(true);
      }
    }
  }
  return result;
}
