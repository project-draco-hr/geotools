{
  final Expression sourceExpression=attMapping.getSourceExpression();
  final AttributeType targetNodeType=attMapping.getTargetNodeInstance();
  StepList xpath=inputXpath == null ? attMapping.getTargetXPath().clone() : inputXpath;
  Map<Name,Expression> clientPropsMappings=attMapping.getClientProperties();
  boolean isNestedFeature=attMapping.isNestedAttribute();
  if (id == null && Expression.NIL != attMapping.getIdentifierExpression()) {
    id=extractIdForAttribute(attMapping.getIdentifierExpression(),source);
  }
  if (attMapping.isNestedAttribute()) {
    NestedAttributeMapping nestedMapping=((NestedAttributeMapping)attMapping);
    Object mappingName=nestedMapping.getNestedFeatureType(source);
    if (mappingName != null) {
      if (nestedMapping.isSameSource() && mappingName instanceof Name) {
        setPolymorphicValues((Name)mappingName,target,id,nestedMapping,source,xpath,clientPropsMappings);
        return null;
      }
 else       if (mappingName instanceof Hints) {
        setPolymorphicReference((Hints)mappingName,clientPropsMappings,target,xpath,targetNodeType);
        return null;
      }
    }
 else {
      return null;
    }
  }
  if (values == null && source != null) {
    values=getValues(attMapping.isMultiValued(),sourceExpression,source);
  }
  boolean isHRefLink=isByReference(clientPropsMappings,isNestedFeature);
  if (isNestedFeature) {
    if (values instanceof Collection) {
      ArrayList<Feature> nestedFeatures=new ArrayList<Feature>(((Collection)values).size());
      for (      Object val : (Collection)values) {
        if (val instanceof Attribute) {
          val=((Attribute)val).getValue();
          if (val instanceof Collection) {
            val=((Collection)val).iterator().next();
          }
          while (val instanceof Attribute) {
            val=((Attribute)val).getValue();
          }
        }
        if (isHRefLink) {
          nestedFeatures.addAll(((NestedAttributeMapping)attMapping).getInputFeatures(this,val,getIdValues(source),source,reprojection,selectedProperties,includeMandatory));
        }
 else {
          nestedFeatures.addAll(((NestedAttributeMapping)attMapping).getFeatures(this,val,getIdValues(source),reprojection,source,selectedProperties,includeMandatory));
        }
      }
      values=nestedFeatures;
    }
 else     if (isHRefLink) {
      values=((NestedAttributeMapping)attMapping).getInputFeatures(this,values,getIdValues(source),source,reprojection,selectedProperties,includeMandatory);
    }
 else {
      values=((NestedAttributeMapping)attMapping).getFeatures(this,values,getIdValues(source),reprojection,source,selectedProperties,includeMandatory);
    }
    if (isHRefLink) {
      setXlinkReference(target,clientPropsMappings,values,xpath,targetNodeType);
      return null;
    }
  }
  if (isNestedFeature) {
    if (values == null) {
      return null;
    }
  }
  if (values instanceof Collection) {
    Map<Object,Object> userData;
    Map<Name,Expression> valueProperties=new HashMap<Name,Expression>();
    for (    Object singleVal : (Collection)values) {
      ArrayList valueList=new ArrayList();
      if (singleVal instanceof Attribute) {
        valueProperties=getClientProperties((Attribute)singleVal);
        if (!valueProperties.isEmpty()) {
          valueProperties.putAll(clientPropsMappings);
        }
      }
      if (!isNestedFeature) {
        if (singleVal instanceof Attribute) {
          singleVal=((Attribute)singleVal).getValue();
        }
        if (singleVal instanceof Collection) {
          valueList.addAll((Collection)singleVal);
        }
 else {
          valueList.add(singleVal);
        }
      }
 else {
        valueList.add(singleVal);
      }
      Attribute instance=xpathAttributeBuilder.set(target,xpath,valueList,id,targetNodeType,false,sourceExpression);
      setClientProperties(instance,source,valueProperties);
    }
  }
 else {
    if (values instanceof Attribute) {
      Map<Name,Expression> newClientProps=getClientProperties((Attribute)values);
      if (!newClientProps.isEmpty()) {
        newClientProps.putAll(clientPropsMappings);
        clientPropsMappings=newClientProps;
      }
      values=((Attribute)values).getValue();
    }
    Attribute instance=xpathAttributeBuilder.set(target,xpath,values,id,targetNodeType,false,sourceExpression);
    setClientProperties(instance,source,clientPropsMappings);
    return instance;
  }
  return null;
}
