{
  String id=getNextFeatureId();
  List<Feature> sources=getSources(id);
  final AttributeDescriptor targetNode=mapping.getTargetFeature();
  final Name targetNodeName=targetNode.getName();
  AttributeBuilder builder=new AttributeBuilder(attf);
  builder.setDescriptor(targetNode);
  Feature target=(Feature)builder.build(id);
  for (  AttributeMapping attMapping : selectedMapping) {
    try {
      if (skipTopElement(targetNodeName,attMapping.getTargetXPath(),targetNode.getType())) {
        continue;
      }
      if (attMapping.isMultiValued()) {
        for (        Feature source : sources) {
          setAttributeValue(target,null,source,attMapping,null,null,selectedProperties.get(attMapping));
        }
      }
 else {
        setAttributeValue(target,null,sources.get(0),attMapping,null,null,selectedProperties.get(attMapping));
        skipNestedMapping(attMapping,sources.subList(1,sources.size()));
      }
    }
 catch (    Exception e) {
      throw new RuntimeException("Error applying mapping with targetAttribute " + attMapping.getTargetXPath(),e);
    }
  }
  cleanEmptyElements(target);
  return target;
}
