{
  URL finalURL=request.getFinalURL();
  HttpURLConnection connection=(HttpURLConnection)finalURL.openConnection();
  connection.addRequestProperty("Accept-Encoding","gzip");
  if (request.requiresPost()) {
    connection.setRequestMethod("POST");
    connection.setDoOutput(true);
    connection.setRequestProperty("Content-type",request.getPostContentType());
    OutputStream outputStream=connection.getOutputStream();
    if (LOGGER.isLoggable(Level.FINE)) {
      ByteArrayOutputStream out=new ByteArrayOutputStream();
      request.performPostOutput(out);
      InputStream in=new ByteArrayInputStream(out.toByteArray());
      BufferedReader reader=new BufferedReader(new InputStreamReader(in));
      PrintStream stream=new PrintStream(outputStream);
      StringBuffer postText=new StringBuffer();
      while (reader.ready()) {
        String input=reader.readLine();
        postText=postText.append(input);
        stream.println(input);
      }
      LOGGER.fine(postText.toString());
      stream.close();
      out.close();
      in.close();
    }
 else {
      request.performPostOutput(outputStream);
    }
    outputStream.flush();
    outputStream.close();
  }
 else {
    connection.setRequestMethod("GET");
  }
  InputStream inputStream=connection.getInputStream();
  if (connection.getContentEncoding() != null && connection.getContentEncoding().indexOf("gzip") != -1) {
    inputStream=new GZIPInputStream(inputStream);
  }
  String contentType=connection.getContentType();
  return request.createResponse(contentType,inputStream);
}
