{
  SimpleFeatureType schema=getSchema();
  String typeName=schema.getTypeName();
  if (query.getTypeName() == null) {
    DefaultQuery defaultQuery=new DefaultQuery(query);
    defaultQuery.setTypeName(typeName);
  }
 else   if (!typeName.equals(query.getTypeName())) {
    return new EmptyFeatureCollection(schema);
  }
  final QueryCapabilities queryCapabilities=getQueryCapabilities();
  if (!queryCapabilities.supportsSorting(query.getSortBy())) {
    throw new DataSourceException("DataStore cannot provide the requested sort order");
  }
  SimpleFeatureCollection collection=new DefaultFeatureResults(this,query);
  if (collection.getSchema().getGeometryDescriptor() == null) {
    return collection;
  }
  return collection;
}
