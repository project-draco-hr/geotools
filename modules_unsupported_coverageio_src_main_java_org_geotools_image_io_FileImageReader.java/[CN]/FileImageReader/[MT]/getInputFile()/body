{
  if (inputFile != null) {
    ensureFileExists(inputFile);
    return inputFile;
  }
  if (input instanceof String) {
    inputFile=new File((String)input);
    ensureFileExists(inputFile);
    return inputFile;
  }
  if (input instanceof File) {
    inputFile=(File)input;
    ensureFileExists(inputFile);
    return inputFile;
  }
  if (input instanceof URI) {
    final URI sourceURI=(URI)input;
    if (sourceURI.getScheme().equalsIgnoreCase("file")) {
      inputFile=new File(sourceURI.getPath());
      ensureFileExists(inputFile);
      return inputFile;
    }
  }
  if (input instanceof URL) {
    final URL sourceURL=(URL)input;
    if (sourceURL.getProtocol().equalsIgnoreCase("file")) {
      inputFile=new File(URLDecoder.decode(sourceURL.getPath(),getURLEncoding()));
      ensureFileExists(inputFile);
      return inputFile;
    }
  }
  final InputStream in=getInputStream();
  String suffix="tmp";
  if (originatingProvider != null) {
    final String[] suffixes=originatingProvider.getFileSuffixes();
    if (suffixes != null && suffixes.length != 0) {
      suffix=suffixes[0];
    }
  }
  inputFile=File.createTempFile("Image",suffix);
  inputFile.deleteOnExit();
  isTemporary=true;
  final OutputStream out=new FileOutputStream(inputFile);
  final byte[] buffer=new byte[8192];
  int length;
  while ((length=in.read(buffer)) >= 0) {
    out.write(buffer,0,length);
  }
  in.close();
  out.close();
  return inputFile;
}
