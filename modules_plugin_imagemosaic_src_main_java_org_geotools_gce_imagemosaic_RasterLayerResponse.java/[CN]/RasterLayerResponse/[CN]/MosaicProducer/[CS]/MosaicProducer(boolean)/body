{
  mergeBehavior=request.getMergeBehavior();
  if (mergeBehavior.equals(MergeBehavior.STACK)) {
    final Map<String,List> requestedAdditionalDomains=request.getRequestedAdditionalDomains();
    if (!requestedAdditionalDomains.isEmpty()) {
      Set<Entry<String,List>> entries=requestedAdditionalDomains.entrySet();
      checkMultipleSelection(entries);
      Entry<String,List> multipleSelectionEntry=null;
      final List<Filter> filters=new ArrayList<Filter>(entries.size());
      for (      Entry<String,List> entry : entries) {
        if (entry.getValue().size() > 1) {
          multipleSelectionEntry=entry;
        }
 else {
          String domainName=entry.getKey() + DomainDescriptor.DOMAIN_SUFFIX;
          filters.add(rasterManager.domainsManager.createFilter(domainName,Arrays.asList(entry.getValue())));
        }
      }
      Filter andFilter=filters.size() > 0 ? FeatureUtilities.DEFAULT_FILTER_FACTORY.and(filters) : null;
      if (multipleSelectionEntry == null) {
        granuleCollectors.add(new GranuleCollector(andFilter,dryRun));
      }
 else {
        final String domainName=multipleSelectionEntry.getKey() + DomainDescriptor.DOMAIN_SUFFIX;
        final List values=multipleSelectionEntry.getValue();
        for (        Object o : values) {
          Filter valueFilter=rasterManager.domainsManager.createFilter(domainName,Arrays.asList(o));
          Filter combinedFilter=andFilter == null ? valueFilter : FeatureUtilities.DEFAULT_FILTER_FACTORY.and(andFilter,valueFilter);
          granuleCollectors.add(new GranuleCollector(combinedFilter,dryRun));
        }
      }
    }
  }
  if (granuleCollectors.isEmpty()) {
    granuleCollectors.add(new GranuleCollector(Filter.INCLUDE,dryRun));
  }
}
