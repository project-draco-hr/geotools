{
  if (canvasSize == null) {
    canvasSize=new Dimension(300,300);
  }
  Document document=null;
  DocumentBuilderFactory dbf=DocumentBuilderFactory.newInstance();
  DocumentBuilder db=dbf.newDocumentBuilder();
  document=db.getDOMImplementation().createDocument(null,"svg",null);
  SVGGeneratorContext ctx1=SVGGeneratorContext.createDefault(document);
  SVGGeneratorContext ctx=ctx1;
  ctx.setComment("Generated by GeoTools2 with Batik SVG Generator");
  SVGGraphics2D g2d=new SVGGraphics2D(ctx,true);
  g2d.setSVGCanvasSize(canvasSize);
  StreamingRenderer renderer=new StreamingRenderer();
  renderer.setMapContent(map);
  Rectangle outputArea=new Rectangle(g2d.getSVGCanvasSize());
  ReferencedEnvelope dataArea=map.getMaxBounds();
  LOGGER.finest("rendering map");
  renderer.paint(g2d,outputArea,dataArea);
  LOGGER.finest("writing to file");
  OutputStreamWriter osw=null;
  try {
    osw=new OutputStreamWriter(out,"UTF-8");
    g2d.stream(osw);
  }
  finally {
    if (osw != null)     osw.close();
  }
}
