{
  String typeName=getSchema().getTypeName();
  StringBuffer sql=new StringBuffer();
  sql.append("SELECT AsText(force_2d(Envelope(");
  boolean useEstimatedExtent=(filter == null || filter == Filter.INCLUDE) && ((PostgisDataStore)getDataStore()).isEstimatedExtent();
  if (useEstimatedExtent) {
    sql.append("estimated_extent(");
    sql.append("'" + typeName + "','"+ geomName+ "'))));");
  }
 else {
    sql.append("Extent(\"" + geomName + "\")))) ");
    sqlBuilder.sqlFrom(sql,typeName);
    sqlBuilder.sqlWhere(sql,filter);
  }
  LOGGER.fine("SQL: " + sql);
  Statement statement=conn.createStatement();
  ResultSet results=statement.executeQuery(sql.toString());
  results.next();
  String wkt=results.getString(1);
  ReferencedEnvelope retEnv=null;
  if (wkt == null) {
    return null;
  }
 else {
    retEnv=ReferencedEnvelope.reference(geometryReader.read(wkt).getEnvelopeInternal());
  }
  results.close();
  statement.close();
  return retEnv;
}
