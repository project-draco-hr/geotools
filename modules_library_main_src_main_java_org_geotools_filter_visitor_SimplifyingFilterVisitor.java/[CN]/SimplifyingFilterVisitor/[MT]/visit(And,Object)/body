{
  List<Filter> newChildren=new ArrayList<Filter>(filter.getChildren().size());
  for (  Filter child : filter.getChildren()) {
    Filter cloned=(Filter)child.accept(this,extraData);
    if (cloned == Filter.EXCLUDE) {
      return Filter.EXCLUDE;
    }
    if (cloned == Filter.INCLUDE) {
      continue;
    }
    if (cloned instanceof And) {
      And and=(And)cloned;
      newChildren.addAll(and.getChildren());
    }
 else {
      newChildren.add(cloned);
    }
  }
  for (int i=0; i < newChildren.size(); i++) {
    for (int j=i + 1; j < newChildren.size(); ) {
      Filter f1=newChildren.get(i);
      Filter f2=newChildren.get(j);
      if (f1.equals(f2)) {
        newChildren.remove(j);
      }
 else       if (dualFilters(f1,f2)) {
        return Filter.EXCLUDE;
      }
 else {
        j++;
      }
    }
  }
  if (newChildren.size() == 0) {
    return Filter.INCLUDE;
  }
  if (newChildren.size() == 1) {
    return newChildren.get(0);
  }
  return getFactory(extraData).and(newChildren);
}
