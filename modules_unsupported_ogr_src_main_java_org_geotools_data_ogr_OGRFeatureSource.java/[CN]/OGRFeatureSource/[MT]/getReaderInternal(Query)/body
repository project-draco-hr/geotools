{
  OGRFilterTranslator filterTx=new OGRFilterTranslator(getSchema(),query.getFilter());
  if (Filter.EXCLUDE.equals(filterTx.getFilter())) {
    return new EmptyFeatureReader<SimpleFeatureType,SimpleFeature>(getSchema());
  }
  Pointer dataSource=null;
  Pointer layer=null;
  boolean cleanup=true;
  try {
    String typeName=getEntry().getTypeName();
    dataSource=getDataStore().openOGRDataSource(false);
    layer=openOGRLayer(dataSource,typeName);
    setLayerFilters(layer,filterTx);
    Filter postFilter=null;
    if (!filterTx.isFilterFullySupported()) {
      postFilter=filterTx.getPostFilter();
    }
    SimpleFeatureType sourceSchema=getSchema();
    SimpleFeatureType querySchema=sourceSchema;
    SimpleFeatureType targetSchema=sourceSchema;
    String[] properties=query.getPropertyNames();
    if (properties != null && properties.length > 0) {
      targetSchema=SimpleFeatureTypeBuilder.retype(sourceSchema,properties);
      querySchema=targetSchema;
      if (postFilter != null) {
        Set<String> queriedAttributes=new HashSet<String>(Arrays.asList(properties));
        FilterAttributeExtractor extraAttributeExtractor=new FilterAttributeExtractor();
        postFilter.accept(extraAttributeExtractor,null);
        Set<String> extraAttributeSet=new HashSet<String>(extraAttributeExtractor.getAttributeNameSet());
        extraAttributeSet.removeAll(queriedAttributes);
        if (extraAttributeSet.size() > 0) {
          String[] queryProperties=new String[properties.length + extraAttributeSet.size()];
          System.arraycopy(properties,0,queryProperties,0,properties.length);
          String[] extraAttributes=(String[])extraAttributeSet.toArray(new String[extraAttributeSet.size()]);
          System.arraycopy(extraAttributes,0,queryProperties,properties.length,extraAttributes.length);
          querySchema=SimpleFeatureTypeBuilder.retype(sourceSchema,queryProperties);
        }
      }
    }
    GeometryFactory gf=getGeometryFactory(query);
    FeatureReader<SimpleFeatureType,SimpleFeature> reader=new OGRFeatureReader(dataSource,layer,querySchema,sourceSchema,gf);
    cleanup=false;
    if (!filterTx.isFilterFullySupported()) {
      reader=new FilteringFeatureReader<SimpleFeatureType,SimpleFeature>(reader,filterTx.getPostFilter());
      if (targetSchema != querySchema) {
        reader=new ReTypeFeatureReader(reader,targetSchema);
      }
    }
    return reader;
  }
  finally {
    if (cleanup) {
      OGRUtils.releaseLayer(layer);
      OGRUtils.releaseDataSource(dataSource);
    }
  }
}
