{
  mappedSource=mapping.getSource();
  if (query instanceof JoiningQuery) {
    if (mappedSource instanceof JDBCFeatureSource) {
      mappedSource=new JoiningJDBCFeatureSource((JDBCFeatureSource)mappedSource);
    }
 else {
      throw new IllegalArgumentException("Joining Query only works on JDBC Feature Source!");
    }
  }
  this.reprojection=query.getCoordinateSystemReproject();
  query.setMaxFeatures(Query.DEFAULT_MAX);
  sourceFeatures=mappedSource.getFeatures(query);
  if (reprojection != null) {
    xpathAttributeBuilder.setCRS(reprojection);
    if (sourceFeatures.getSchema().getGeometryDescriptor() == null) {
      query.setCoordinateSystemReproject(null);
    }
  }
  if (!(this instanceof XmlMappingFeatureIterator)) {
    this.sourceFeatureIterator=sourceFeatures.iterator();
  }
  for (  AttributeMapping attMapping : selectedMapping) {
    if (attMapping instanceof JoiningNestedAttributeMapping) {
      ((JoiningNestedAttributeMapping)attMapping).open(this,query);
    }
  }
}
