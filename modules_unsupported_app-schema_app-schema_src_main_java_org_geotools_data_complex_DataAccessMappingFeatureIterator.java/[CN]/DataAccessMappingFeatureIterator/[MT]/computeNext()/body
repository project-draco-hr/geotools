{
  if (curSrcFeature == null) {
    throw new UnsupportedOperationException("No features found in next()." + "This wouldn't have happenned if hasNext() was called beforehand.");
  }
  setHasNextCalled(false);
  ArrayList<Feature> sources=new ArrayList<Feature>();
  String id=extractIdForFeature(curSrcFeature);
  if (isFiltered) {
    setNextFilteredFeature(id,sources);
  }
 else {
    setNextFeature(id,sources);
  }
  final AttributeDescriptor targetNode=mapping.getTargetFeature();
  final Name targetNodeName=targetNode.getName();
  final List<AttributeMapping> mappings=mapping.getAttributeMappings();
  AttributeBuilder builder=new AttributeBuilder(attf);
  builder.setDescriptor(targetNode);
  Feature target=(Feature)builder.build(id);
  for (  AttributeMapping attMapping : mappings) {
    if (propertyNames == null || propertyNames.contains(attMapping.getTargetXPath().get(0).getName().getLocalPart())) {
      try {
        if (isTopLevelmapping(targetNodeName,attMapping.getTargetXPath())) {
          continue;
        }
        if (attMapping.isMultiValued()) {
          for (          Feature source : sources) {
            setAttributeValue(target,source,attMapping,null,null);
          }
        }
 else {
          setAttributeValue(target,sources.get(0),attMapping,null,null);
        }
      }
 catch (      Exception e) {
        throw new RuntimeException("Error applying mapping with targetAttribute " + attMapping.getTargetXPath(),e);
      }
    }
  }
  return target;
}
