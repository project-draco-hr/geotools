{
  if (target == null) {
    return;
  }
  final Map<Name,Object> targetAttributes=new HashMap<Name,Object>();
  if (target.getUserData().containsValue(Attributes.class)) {
    targetAttributes.putAll((Map<? extends Name,? extends Object>)target.getUserData().get(Attributes.class));
  }
  for (  Map.Entry<Name,Expression> entry : clientProperties.entrySet()) {
    Name propName=entry.getKey();
    Object propExpr=entry.getValue();
    Object propValue;
    if (propExpr instanceof Expression) {
      propValue=getValue((Expression)propExpr,source);
    }
 else {
      propValue=propExpr;
    }
    targetAttributes.put(propName,propValue);
  }
  if (targetAttributes.size() > 0) {
    target.getUserData().put(Attributes.class,targetAttributes);
  }
  if (target instanceof GeometryAttribute && (targetAttributes.size() > 0 || target.getIdentifier() != null)) {
    Geometry geom;
    if (target.getValue() == null) {
      geom=new EmptyGeometry();
    }
 else {
      geom=(Geometry)((Geometry)target.getValue()).clone();
    }
    if (geom != null) {
      Object userData=geom.getUserData();
      Map newUserData=new HashMap<Object,Object>();
      if (userData != null) {
        if (userData instanceof Map) {
          newUserData.putAll((Map)userData);
        }
 else         if (userData instanceof CoordinateReferenceSystem) {
          newUserData.put(CoordinateReferenceSystem.class,userData);
        }
      }
      if (target.getIdentifier() != null) {
        newUserData.put("gml:id",target.getIdentifier().toString());
      }
      if (targetAttributes.size() > 0) {
        newUserData.put(Attributes.class,targetAttributes);
      }
      geom.setUserData(newUserData);
      target.setValue(geom);
    }
  }
}
