{
  if (mapping instanceof XmlFeatureTypeMapping) {
    return new XmlMappingFeatureIterator(store,mapping,query);
  }
  if (AppSchemaDataAccessConfigurator.isJoining()) {
    if (!(query instanceof JoiningQuery)) {
      query=new JoiningQuery(query);
    }
    FeatureSource mappedSource=mapping.getSource();
    FilterCapabilities capabilities=null;
    if (mappedSource instanceof JDBCFeatureSource) {
      capabilities=((JDBCFeatureSource)mappedSource).getDataStore().getFilterCapabilities();
    }
 else     if (mappedSource instanceof JDBCFeatureStore) {
      capabilities=((JDBCFeatureStore)mappedSource).getDataStore().getFilterCapabilities();
    }
 else {
      throw new IllegalArgumentException("Joining queries are only supported on JDBC data stores");
    }
    IMappingFeatureIterator iterator;
    if (unrolledFilter != null) {
      query.setFilter(Filter.INCLUDE);
      Query unrolledQuery=store.unrollQuery(query,mapping);
      unrolledQuery.setFilter(unrolledFilter);
      iterator=new DataAccessMappingFeatureIterator(store,mapping,query,false,unrolledQuery);
    }
 else {
      Filter filter=query.getFilter();
      ComplexFilterSplitter splitter=new ComplexFilterSplitter(capabilities,mapping);
      filter.accept(splitter,null);
      query.setFilter(splitter.getFilterPre());
      filter=splitter.getFilterPost();
      int maxFeatures=Query.DEFAULT_MAX;
      if (filter != null && filter != Filter.INCLUDE) {
        maxFeatures=query.getMaxFeatures();
        query.setMaxFeatures(Query.DEFAULT_MAX);
      }
      iterator=new DataAccessMappingFeatureIterator(store,mapping,query,false);
      if (filter != null && filter != Filter.INCLUDE) {
        iterator=new PostFilteringMappingFeatureIterator(iterator,filter,maxFeatures);
      }
    }
    return iterator;
  }
 else {
    if (query.getFilter() != null) {
      Query unrolledQuery=store.unrollQuery(query,mapping);
      Filter filter=unrolledQuery.getFilter();
      CheckIfNestedFilterVisitor visitor=new CheckIfNestedFilterVisitor();
      filter.accept(visitor,null);
      if (visitor.hasNestedAttributes) {
        unrolledQuery.setFilter(Filter.INCLUDE);
        return new FilteringMappingFeatureIterator(store,mapping,query,unrolledQuery,filter);
      }
 else       if (!filter.equals(Filter.INCLUDE) && !filter.equals(Filter.EXCLUDE) && !(filter instanceof FidFilterImpl)) {
        return new DataAccessMappingFeatureIterator(store,mapping,query,true,unrolledQuery);
      }
    }
    return new DataAccessMappingFeatureIterator(store,mapping,query,false);
  }
}
