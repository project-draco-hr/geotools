{
  final int startPosition=toAppendTo.length();
  if (!last) {
    numberFormat.setMinimumIntegerDigits(w);
    numberFormat.setMaximumFractionDigits(0);
    toAppendTo=numberFormat.format(value,toAppendTo,dummy);
  }
 else {
    value=doRounding(value,widthDecimal);
    if (decimalSeparator) {
      numberFormat.setMinimumIntegerDigits(w);
      numberFormat.setMinimumFractionDigits(widthDecimal);
      numberFormat.setMaximumFractionDigits(widthDecimal);
      toAppendTo=numberFormat.format(value,toAppendTo,dummy);
    }
 else {
      value*=XMath.pow10(widthDecimal);
      numberFormat.setMaximumFractionDigits(0);
      numberFormat.setMinimumIntegerDigits(w + widthDecimal);
      toAppendTo=numberFormat.format(value,toAppendTo,dummy);
    }
  }
  if (s != null) {
    toAppendTo.append(s);
  }
  if (pos != null) {
    pos.setBeginIndex(startPosition);
    pos.setEndIndex(toAppendTo.length() - 1);
  }
  return toAppendTo;
}
