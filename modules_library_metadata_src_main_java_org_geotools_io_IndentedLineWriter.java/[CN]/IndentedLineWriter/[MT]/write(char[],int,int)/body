{
  final int upper=offset + length;
synchronized (lock) {
    check:     while (offset < upper) {
      if (newLine) {
        doWrite(buffer[offset++]);
        continue;
      }
      final int lower=offset;
      do {
        final char c=buffer[offset];
        if (c == '\r' || c == '\n') {
          out.write(buffer,lower,offset - lower);
          doWrite(c);
          offset++;
          continue check;
        }
      }
 while (++offset < upper);
      out.write(buffer,lower,offset - lower);
      break;
    }
  }
}
