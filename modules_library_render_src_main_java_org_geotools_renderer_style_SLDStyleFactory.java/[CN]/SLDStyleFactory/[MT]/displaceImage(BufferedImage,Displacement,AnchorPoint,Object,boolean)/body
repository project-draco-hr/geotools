{
  if (displacement == null && anchor == null) {
    return image;
  }
  int dx=0;
  int dy=0;
  if (displacement != null) {
    dx=evalToInt(displacement.getDisplacementX(),feature,0);
    dy=evalToInt(displacement.getDisplacementY(),feature,0);
  }
  double ax=0.5;
  double ay=0.5;
  if (anchor != null) {
    ax=evalToDouble(anchor.getAnchorPointX(),feature,0.5f);
    ay=evalToDouble(anchor.getAnchorPointY(),feature,0.5f);
  }
  if (dx == 0 && dy == 0 && ax == 0.5 && ay == 0.5) {
    return image;
  }
  if (dx > MAX_RASTERIZATION_SIZE || dy > MAX_RASTERIZATION_SIZE) {
    throw new IllegalArgumentException("Displacement is too large, max value is " + MAX_RASTERIZATION_SIZE);
  }
  int type=image.getType() == 0 ? BufferedImage.TYPE_4BYTE_ABGR : image.getType();
  BufferedImage bi;
  AffineTransform at;
  if (fill) {
    bi=new BufferedImage(image.getWidth() + Math.abs(dx),image.getHeight() + Math.abs(dy),type);
    int tx=(int)Math.round((bi.getWidth() - image.getWidth()) * ax);
    int ty=(int)Math.round((bi.getHeight() - image.getHeight()) * ay);
    at=AffineTransform.getTranslateInstance(tx,ty);
  }
 else {
    int tx=dx > 0 ? dx : 0;
    int ty=dy > 0 ? dy : 0;
    tx+=(ax - 0.5) * image.getWidth();
    ty+=(ay - 0.5) * image.getHeight();
    at=AffineTransform.getTranslateInstance(tx,ty);
    bi=new BufferedImage(image.getWidth() + Math.abs(tx),image.getHeight() + Math.abs(ty),type);
  }
  Graphics2D graphics=bi.createGraphics();
  graphics.drawRenderedImage(image,at);
  graphics.dispose();
  return bi;
}
