{
  HttpURLConnection connection=(HttpURLConnection)url.openConnection();
  if (POST == method) {
    connection.setRequestMethod("POST");
    connection.setDoOutput(true);
    if (url == null || !url.toString().contains("/ArcGIS/services/")) {
      connection.setRequestProperty("Content-type","text/xml, application/xml");
    }
  }
 else {
    connection.setRequestMethod("GET");
  }
  connection.setDoInput(true);
  if (tryGzip) {
    connection.addRequestProperty("Accept-Encoding","gzip");
  }
  connection.setConnectTimeout(timeoutMillis);
  connection.setReadTimeout(timeoutMillis);
  if (auth != null) {
    if (auth instanceof WFSAuthenticator) {
      WFSAuthenticator wfsAuth=(WFSAuthenticator)auth;
      String user=wfsAuth.pa.getUserName();
      char[] pass=wfsAuth.pa.getPassword();
      String combined=String.format("%s:%s",user,String.valueOf(pass));
      byte[] authBytes=combined.getBytes("US-ASCII");
      String encoded=new String(Base64.encodeBase64(authBytes));
      String authorization="Basic " + encoded;
      connection.setRequestProperty("Authorization",authorization);
    }
 else {
synchronized (Authenticator.class) {
        Authenticator.setDefault(auth);
        connection.connect();
      }
    }
  }
  return connection;
}
