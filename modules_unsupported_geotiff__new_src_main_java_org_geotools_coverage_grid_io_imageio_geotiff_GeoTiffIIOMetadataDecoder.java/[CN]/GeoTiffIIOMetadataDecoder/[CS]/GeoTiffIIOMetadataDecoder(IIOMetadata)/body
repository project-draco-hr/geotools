{
  if (imageMetadata == null) {
    throw new IllegalArgumentException(Errors.format(ErrorKeys.NULL_ARGUMENT_$1,"imageMetadata"));
  }
  rootNode=(IIOMetadataNode)imageMetadata.getAsTree(imageMetadata.getNativeMetadataFormatName());
  if (rootNode == null) {
    throw new NullPointerException("Unable to retrieve metadata");
  }
  IIOMetadataNode geoKeyDir=GeoTiffUtilities.getTiffField(rootNode,GeoTIFFTagSet.TAG_GEO_KEY_DIRECTORY);
  geoKeys=new HashMap<Integer,GeoKeyEntry>();
  if (geoKeyDir != null) {
    NodeList geoKeyDirEntries=geoKeyDir.getFirstChild().getChildNodes();
    for (int i=4; i < geoKeyDirEntries.getLength(); i+=4) {
      int keyID=GeoTiffUtilities.getIntValueAttribute(geoKeyDirEntries.item(i));
      GeoKeyEntry key=new GeoKeyEntry(keyID,GeoTiffUtilities.getIntValueAttribute(geoKeyDirEntries.item(i + 1)),GeoTiffUtilities.getIntValueAttribute(geoKeyDirEntries.item(i + 2)),GeoTiffUtilities.getIntValueAttribute(geoKeyDirEntries.item(i + 3)));
      if (!geoKeys.containsKey(keyID)) {
        geoKeys.put(keyID,key);
      }
    }
    geoKeyDirVersion=GeoTiffUtilities.getTiffShort(geoKeyDir,GeoTiffGCSCodes.GEO_KEY_DIRECTORY_VERSION_INDEX);
    geoKeyRevision=GeoTiffUtilities.getTiffShort(geoKeyDir,GeoTiffGCSCodes.GEO_KEY_REVISION_INDEX);
    if (geoKeyRevision != 1) {
      geoKeyRevision=1;
    }
    geoKeyMinorRevision=GeoTiffUtilities.getTiffShort(geoKeyDir,GeoTiffGCSCodes.GEO_KEY_MINOR_REVISION_INDEX);
    geoKeyDirTagsNum=GeoTiffUtilities.getTiffShort(geoKeyDir,GeoTiffGCSCodes.GEO_KEY_NUM_KEYS_INDEX);
  }
 else {
    if (LOGGER.isLoggable(Level.FINE))     LOGGER.log(Level.FINE,"Unable to find the geo key directory tag");
  }
  pixelScale=GeoTiffUtilities.calculateModelPixelScales(rootNode);
  tiePoints=GeoTiffUtilities.calculateTiePoints(rootNode);
  noData=GeoTiffUtilities.calculateNoData(rootNode);
  modelTransformation=GeoTiffUtilities.calculateModelTransformation(rootNode);
}
