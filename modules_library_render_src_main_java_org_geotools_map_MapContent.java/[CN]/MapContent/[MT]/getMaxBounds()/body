{
  CoordinateReferenceSystem mapCrs=null;
  if (viewport != null) {
    mapCrs=viewport.getCoordianteReferenceSystem();
  }
  ReferencedEnvelope maxBounds=null;
  for (  Layer layer : layers()) {
    if (layer == null) {
      continue;
    }
    try {
      ReferencedEnvelope layerBounds=layer.getBounds();
      if (layerBounds == null || layerBounds.isEmpty() || layerBounds.isNull()) {
        continue;
      }
      if (mapCrs == null) {
        maxBounds=new ReferencedEnvelope(layerBounds);
        mapCrs=layerBounds.getCoordinateReferenceSystem();
        continue;
      }
      ReferencedEnvelope normalized;
      if (CRS.equalsIgnoreMetadata(mapCrs,layerBounds.getCoordinateReferenceSystem())) {
        normalized=layerBounds;
      }
 else {
        try {
          normalized=layerBounds.transform(mapCrs,true);
        }
 catch (        Exception e) {
          LOGGER.log(Level.FINE,"Unable to transform: {0}",e);
          continue;
        }
      }
      if (maxBounds == null) {
        maxBounds=normalized;
      }
 else {
        maxBounds.expandToInclude(normalized);
      }
    }
 catch (    Throwable eek) {
      LOGGER.warning("Unable to determine bounds of " + layer + ":"+ eek);
    }
  }
  if (maxBounds == null && mapCrs != null) {
    maxBounds=new ReferencedEnvelope(mapCrs);
  }
  return maxBounds;
}
