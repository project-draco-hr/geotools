{
  Transaction t1=new DefaultTransaction();
  Transaction t2=new DefaultTransaction();
  FeatureWriter<SimpleFeatureType,SimpleFeature> writer1=data.getFeatureWriter("road",rd1Filter,t1);
  FeatureWriter<SimpleFeatureType,SimpleFeature> writer2=data.getFeatureWriterAppend("road",t2);
  SimpleFeatureType road=data.getSchema("road");
  FeatureReader<SimpleFeatureType,SimpleFeature> reader;
  SimpleFeature feature;
  SimpleFeature[] ORIGINAL=roadFeatures;
  SimpleFeature[] REMOVE=new SimpleFeature[ORIGINAL.length - 1];
  SimpleFeature[] ADD=new SimpleFeature[ORIGINAL.length + 1];
  SimpleFeature[] FINAL=new SimpleFeature[ORIGINAL.length];
  int i;
  int index;
  index=0;
  for (i=0; i < ORIGINAL.length; i++) {
    feature=ORIGINAL[i];
    if (!feature.getID().equals(roadFeatures[0].getID())) {
      REMOVE[index++]=feature;
    }
  }
  for (i=0; i < ORIGINAL.length; i++) {
    ADD[i]=ORIGINAL[i];
  }
  ADD[i]=newRoad;
  for (i=0; i < REMOVE.length; i++) {
    FINAL[i]=REMOVE[i];
  }
  FINAL[i]=newRoad;
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),Transaction.AUTO_COMMIT);
  assertTrue("Sanity check failed: before modification reader didn't match original content",covers(reader,ORIGINAL));
  reader.close();
  while (writer1.hasNext()) {
    feature=(SimpleFeature)writer1.next();
    assertEquals(roadFeatures[0].getID(),feature.getID());
    writer1.remove();
  }
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),Transaction.AUTO_COMMIT);
  assertTrue("Feature deletion managed to leak out of transaction?",covers(reader,ORIGINAL));
  reader.close();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),t1);
  assertTrue(covers(reader,REMOVE));
  reader.close();
  writer1.close();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),Transaction.AUTO_COMMIT);
  assertTrue(covers(reader,ORIGINAL));
  reader.close();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),t1);
  assertTrue(covers(reader,REMOVE));
  reader.close();
  feature=(SimpleFeature)writer2.next();
  feature.setAttributes(newRoad.getAttributes());
  writer2.write();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),t2);
  newRoad=findFeature(reader,"id",new Integer(4));
  System.out.println("newRoad:" + newRoad);
  ADD[ADD.length - 1]=newRoad;
  FINAL[FINAL.length - 1]=newRoad;
  reader.close();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),Transaction.AUTO_COMMIT);
  assertTrue(covers(reader,ORIGINAL));
  reader.close();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),t2);
  assertMatched(ADD,reader);
  reader.close();
  writer2.close();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),Transaction.AUTO_COMMIT);
  assertTrue(covers(reader,ORIGINAL));
  reader.close();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),t2);
  assertTrue(coversLax(reader,ADD));
  reader.close();
  t1.commit();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),Transaction.AUTO_COMMIT);
  assertTrue(covers(reader,REMOVE));
  reader.close();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),t1);
  assertTrue(covers(reader,REMOVE));
  reader.close();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),t2);
  assertTrue(coversLax(reader,FINAL));
  reader.close();
  t2.commit();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),Transaction.AUTO_COMMIT);
  assertTrue(coversLax(reader,FINAL));
  reader.close();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),t1);
  assertTrue(coversLax(reader,FINAL));
  reader.close();
  reader=data.getFeatureReader(new DefaultQuery("road",Filter.INCLUDE),t2);
  assertTrue(coversLax(reader,FINAL));
  reader.close();
  t1.close();
  t2.close();
}
