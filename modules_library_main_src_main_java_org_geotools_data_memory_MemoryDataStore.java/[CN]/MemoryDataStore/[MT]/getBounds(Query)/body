{
  String typeName=query.getTypeName();
  Map<String,SimpleFeature> contents=features(typeName);
  Iterator<SimpleFeature> iterator=contents.values().iterator();
  CoordinateReferenceSystem coordinateSystem=query.getCoordinateSystem();
  if (coordinateSystem == null) {
    SimpleFeatureType type=schema.get(typeName);
    if (type != null) {
      coordinateSystem=type.getCoordinateReferenceSystem();
    }
  }
  ReferencedEnvelope envelope=null;
  Filter filter=query.getFilter();
  int count=0;
  while (iterator.hasNext() && (count < query.getMaxFeatures())) {
    count++;
    SimpleFeature feature=iterator.next();
    if (filter.evaluate(feature)) {
      count++;
      if (null == envelope) {
        envelope=new ReferencedEnvelope(coordinateSystem);
      }
      Geometry geom=(Geometry)feature.getDefaultGeometry();
      Envelope env=geom != null ? geom.getEnvelopeInternal() : null;
      if (env != null) {
        envelope.expandToInclude(env);
      }
    }
  }
  return envelope;
}
